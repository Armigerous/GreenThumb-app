# 🔧 OAuth Authentication Troubleshooting Guide\n\n> **Issue:** Google OAuth authentication appears to work (no errors) but doesn't create users in Clerk or Supabase \n> **Date:** January 15, 2025 \n> **Status:** Investigating\n\n---\n\n## 🔍 Common OAuth Issues & Solutions\n\n### 1. **Clerk Dashboard Configuration**\n\n#### ✅ **Check OAuth Providers**\n- Go to Clerk Dashboard → Authentication → Social Connections\n- Ensure Google OAuth is **enabled** and **configured**\n- Verify Client ID and Client Secret are set\n- Check that the OAuth provider is **active**\n\n#### ✅ **Redirect URLs**\nEnsure these redirect URLs are configured in both:\n\n**Clerk Dashboard:**\n`\n# For Expo Go (Development)\nexp://127.0.0.1:19000/--/oauth-native-callback\nexp://localhost:19000/--/oauth-native-callback\n\n# For Production (when built)\ngreenthumb://oauth-native-callback\n`\n\n**Google Cloud Console:**\n`\n# OAuth 2.0 Client IDs → Authorized redirect URIs\nexp://127.0.0.1:19000/--/oauth-native-callback\nexp://localhost:19000/--/oauth-native-callback\ngreenthumb://oauth-native-callback\n`\n\n### 2. **App Configuration Issues**\n\n#### ✅ **Scheme Configuration**\nCheck `app.config.js`:\n`javascript\nmodule.exports = {\n  expo: {\n    scheme: \"greenthumb\", // ✅ This should match redirect URLs\n    // ...\n  }\n};\n`\n\n#### ✅ **OAuth Callback Screen**\nEnsure `app/(auth)/oauth-native-callback.tsx` exists and is registered in `_layout.tsx`\n\n### 3. **Development Environment Issues**\n\n#### ✅ **Expo Go vs Development Build**\n- **Expo Go:** Uses `exp://` scheme\n- **Development Build:** Uses custom scheme (`greenthumb://`)\n- OAuth behavior differs between environments\n\n#### ✅ **Network Configuration**\n- Ensure device and development server are on same network\n- Check firewall settings\n- Try different network if issues persist\n\n### 4. **Code Implementation Issues**\n\n#### ✅ **Missing Dependencies**\nEnsure these are installed:\n`bash\nnpm install @clerk/clerk-expo expo-auth-session expo-web-browser\n`\n\n#### ✅ **WebBrowser Configuration**\nCheck that `WebBrowser.maybeCompleteAuthSession()` is called:\n`typescript\nimport * as WebBrowser from \"expo-web-browser\";\n\n// This should be at the top level of auth screens\nWebBrowser.maybeCompleteAuthSession();\n`\n\n---\n\n## 🐛 Debugging Steps\n\n### Step 1: Enable Detailed Logging\n\nAdd this to your OAuth handler:\n`` typescript\nconst onSocialAuth = React.useCallback(\n  async (strategy: \"oauth_google\" | \"oauth_apple\" | \"oauth_facebook\") => {\n    try {\n      console.log(`🚀 Starting ${strategy} authentication...`);\n      console.log(`📱 Current URL scheme:`, Constants.expoConfig?.scheme);\n      \n      setIsLoading(true);\n      setError(null);\n\n      const result = await startSSOFlow({ strategy });\n      console.log(`📱 SSO Flow result:`, JSON.stringify(result, null, 2));\n\n      // ... rest of handler\n    } catch (err: any) {\n      console.error(`❌ ${strategy} Auth Error:`, err);\n      console.error(`Error details:`, JSON.stringify(err, null, 2));\n      // ...\n    }\n  },\n  [authMode, router, startSSOFlow]\n);\n ``\n\n### Step 2: Test OAuth Flow\n\n1. **Clear Expo cache:** `npx expo start --clear`\n2. **Test in Expo Go** first\n3. **Check console logs** during OAuth flow\n4. **Verify redirect** happens correctly\n\n### Step 3: Check Clerk Dashboard\n\n1. Go to **Users** section in Clerk Dashboard\n2. Check if user appears after OAuth attempt\n3. Look at **Events** tab for OAuth events\n4. Check **Logs** for any errors\n\n### Step 4: Verify Supabase Integration\n\n1. Check if `requesting_user_id()` function exists\n2. Verify JWT template is configured in Clerk\n3. Test Supabase connection after OAuth\n\n---\n\n## 🔧 Quick Fixes\n\n### Fix 1: Update OAuth Callback\n\n`typescript\n// app/(auth)/oauth-native-callback.tsx\nimport { useEffect } from \"react\";\nimport { View, ActivityIndicator } from \"react-native\";\nimport { useRouter, useLocalSearchParams } from \"expo-router\";\nimport { useAuth } from \"@clerk/clerk-expo\";\n\nexport default function OAuthCallback() {\n  const { isLoaded, isSignedIn, userId } = useAuth();\n  const router = useRouter();\n  const params = useLocalSearchParams();\n\n  useEffect(() => {\n    console.log(\"🔄 OAuth Callback - isLoaded:\", isLoaded, \"isSignedIn:\", isSignedIn);\n    console.log(\"🔄 OAuth Callback - userId:\", userId);\n    console.log(\"🔄 OAuth Callback - params:\", params);\n\n    if (isLoaded) {\n      if (isSignedIn) {\n        console.log(\"✅ OAuth Success - Redirecting to home\");\n        router.replace(\"/\");\n      } else {\n        console.log(\"❌ OAuth Failed - Redirecting to sign-in\");\n        router.replace(\"/(auth)/sign-in\");\n      }\n    }\n  }, [isLoaded, isSignedIn, router, userId, params]);\n\n  return (\n    <View className=\"flex-1 justify-center items-center\">\n      <ActivityIndicator size=\"large\" />\n    </View>\n  );\n}\n`\n\n### Fix 2: Add OAuth Error Handling\n\n`` typescript\nconst onSocialAuth = React.useCallback(\n  async (strategy: \"oauth_google\" | \"oauth_apple\" | \"oauth_facebook\") => {\n    try {\n      console.log(`🚀 Starting ${strategy} authentication...`);\n      setIsLoading(true);\n      setError(null);\n\n      const result = await startSSOFlow({ strategy });\n      console.log(`📱 SSO Flow result:`, result);\n\n      if (result.createdSessionId) {\n        console.log(`✅ Session created: ${result.createdSessionId}`);\n        await result.setActive({ session: result.createdSessionId });\n        console.log(`🏠 Navigating to home...`);\n        router.replace(\"/\");\n      } else {\n        console.log(`❌ No session created from ${strategy}`);\n        console.log(`📋 Full result:`, JSON.stringify(result, null, 2));\n        setError(`Authentication with ${strategy} failed. Please try again.`);\n      }\n    } catch (err: any) {\n      console.error(`❌ ${strategy} Auth Error:`, err);\n      \n      // Check for specific OAuth errors\n      if (err.code === 'oauth_access_denied') {\n        setError('Authentication was cancelled. Please try again.');\n      } else if (err.code === 'oauth_callback_error') {\n        setError('OAuth callback failed. Please check your configuration.');\n      } else {\n        setError(getFriendlyErrorMessage(err, authMode));\n      }\n    } finally {\n      setIsLoading(false);\n    }\n  },\n  [authMode, router, startSSOFlow]\n);\n ``\n\n---\n\n## 📋 Checklist\n\n- [ ] Google OAuth enabled in Clerk Dashboard\n- [ ] Client ID and Secret configured\n- [ ] Redirect URLs match in Clerk and Google Console\n- [ ] App scheme configured correctly\n- [ ] OAuth callback screen exists and registered\n- [ ] WebBrowser session completion called\n- [ ] Detailed logging enabled\n- [ ] Tested in Expo Go environment\n- [ ] Checked Clerk Dashboard for user creation\n- [ ] Verified Supabase integration\n\n---\n\n## 🆘 Still Not Working?\n\n1. **Check Expo logs** for detailed error messages\n2. **Test with original sign-in screen** to isolate issue\n3. **Try different OAuth provider** (Apple/Facebook) to narrow down\n4. **Contact Clerk support** with specific error logs\n5. **Review Clerk documentation** for latest OAuth setup\n\n---\n\n## 📚 Resources\n\n- [Clerk OAuth Documentation](https://clerk.com/docs/authentication/social-connections)\n- [Expo OAuth Guide](https://docs.expo.dev/guides/authentication/#oauth)\n- [Google OAuth Setup](https://developers.google.com/identity/protocols/oauth2)\n
